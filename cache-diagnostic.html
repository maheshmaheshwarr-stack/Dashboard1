<!DOCTYPE html>
<html>
<head>
    <title>Cache Diagnostic</title>
    <style>
        body {
            font-family: monospace;
            max-width: 900px;
            margin: 40px auto;
            padding: 20px;
            background: #1e293b;
            color: #e2e8f0;
        }
        .section {
            background: #334155;
            padding: 20px;
            margin: 20px 0;
            border-radius: 8px;
            border-left: 4px solid #3b82f6;
        }
        .success { border-left-color: #10b981; }
        .warning { border-left-color: #f59e0b; }
        .error { border-left-color: #ef4444; }
        button {
            background: #3b82f6;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 6px;
            cursor: pointer;
            margin: 8px 4px;
            font-weight: 600;
        }
        button:hover { background: #2563eb; }
        pre {
            background: #1e293b;
            padding: 12px;
            border-radius: 4px;
            overflow-x: auto;
        }
        h1 { color: #60a5fa; }
        h2 { color: #93c5fd; margin-top: 0; }
    </style>
</head>
<body>
    <h1>üîç Dashboard1 Cache Diagnostic</h1>
    
    <div class="section">
        <h2>Current Page Info</h2>
        <div id="page-info"></div>
    </div>

    <div class="section">
        <h2>Service Worker Status</h2>
        <div id="sw-status"></div>
        <button onclick="unregisterSW()">Unregister Service Worker</button>
    </div>

    <div class="section">
        <h2>Cache Storage</h2>
        <div id="cache-info"></div>
        <button onclick="clearAllCaches()">Clear All Caches</button>
    </div>

    <div class="section">
        <h2>Local Storage</h2>
        <div id="storage-info"></div>
        <button onclick="clearStorage()">Clear Local Storage</button>
    </div>

    <div class="section">
        <h2>Quick Actions</h2>
        <button onclick="fullReset()">üî• FULL RESET (Clear Everything)</button>
        <button onclick="window.location.reload(true)">üîÑ Hard Reload</button>
        <button onclick="window.location.href='index.html?nocache=' + Date.now()">üìÑ Open Main Page (No Cache)</button>
    </div>

    <div class="section">
        <h2>Instructions</h2>
        <ol>
            <li>Click "FULL RESET" button above</li>
            <li>Wait for confirmation</li>
            <li>Click "Open Main Page (No Cache)"</li>
            <li>Select ‡Æ§‡ÆÆ‡Æø‡Æ¥‡Øç from language dropdown</li>
            <li>Check if UI is in Tamil</li>
        </ol>
    </div>

    <script>
        // Page Info
        function updatePageInfo() {
            const info = document.getElementById('page-info');
            info.innerHTML = `
                <pre>URL: ${window.location.href}
Protocol: ${window.location.protocol}
Host: ${window.location.host}
Pathname: ${window.location.pathname}
User Agent: ${navigator.userAgent}
Language: ${navigator.language}
Online: ${navigator.onLine}
Timestamp: ${new Date().toISOString()}</pre>
            `;
        }

        // Service Worker Status
        async function updateSWStatus() {
            const status = document.getElementById('sw-status');
            
            if ('serviceWorker' in navigator) {
                const registrations = await navigator.serviceWorker.getRegistrations();
                
                if (registrations.length === 0) {
                    status.innerHTML = '<p style="color: #10b981;">‚úÖ No service workers registered</p>';
                } else {
                    let html = '<p style="color: #f59e0b;">‚ö†Ô∏è Service workers found:</p><ul>';
                    registrations.forEach((reg, i) => {
                        html += `<li>SW ${i + 1}: ${reg.scope}<br>State: ${reg.active?.state || 'N/A'}</li>`;
                    });
                    html += '</ul>';
                    status.innerHTML = html;
                }
            } else {
                status.innerHTML = '<p style="color: #ef4444;">‚ùå Service Worker not supported</p>';
            }
        }

        async function unregisterSW() {
            if ('serviceWorker' in navigator) {
                const registrations = await navigator.serviceWorker.getRegistrations();
                for (let reg of registrations) {
                    await reg.unregister();
                }
                alert('‚úÖ All service workers unregistered!');
                updateSWStatus();
            }
        }

        // Cache Info
        async function updateCacheInfo() {
            const info = document.getElementById('cache-info');
            
            if ('caches' in window) {
                const cacheNames = await caches.keys();
                
                if (cacheNames.length === 0) {
                    info.innerHTML = '<p style="color: #10b981;">‚úÖ No caches found</p>';
                } else {
                    let html = '<p style="color: #f59e0b;">‚ö†Ô∏è Caches found:</p><ul>';
                    for (let name of cacheNames) {
                        const cache = await caches.open(name);
                        const keys = await cache.keys();
                        html += `<li><strong>${name}</strong> (${keys.length} items)</li>`;
                    }
                    html += '</ul>';
                    info.innerHTML = html;
                }
            } else {
                info.innerHTML = '<p style="color: #ef4444;">‚ùå Cache API not supported</p>';
            }
        }

        async function clearAllCaches() {
            if ('caches' in window) {
                const cacheNames = await caches.keys();
                for (let name of cacheNames) {
                    await caches.delete(name);
                }
                alert('‚úÖ All caches cleared!');
                updateCacheInfo();
            }
        }

        // Storage Info
        function updateStorageInfo() {
            const info = document.getElementById('storage-info');
            const items = [];
            
            for (let i = 0; i < localStorage.length; i++) {
                const key = localStorage.key(i);
                const value = localStorage.getItem(key);
                items.push(`<li><strong>${key}:</strong> ${value.substring(0, 50)}${value.length > 50 ? '...' : ''}</li>`);
            }
            
            if (items.length === 0) {
                info.innerHTML = '<p style="color: #10b981;">‚úÖ Local storage is empty</p>';
            } else {
                info.innerHTML = `<p style="color: #f59e0b;">‚ö†Ô∏è Items in local storage:</p><ul>${items.join('')}</ul>`;
            }
        }

        function clearStorage() {
            localStorage.clear();
            sessionStorage.clear();
            alert('‚úÖ All storage cleared!');
            updateStorageInfo();
        }

        // Full Reset
        async function fullReset() {
            if (!confirm('This will clear ALL caches, service workers, and storage. Continue?')) {
                return;
            }

            // Unregister service workers
            if ('serviceWorker' in navigator) {
                const registrations = await navigator.serviceWorker.getRegistrations();
                for (let reg of registrations) {
                    await reg.unregister();
                }
            }

            // Clear all caches
            if ('caches' in window) {
                const cacheNames = await caches.keys();
                for (let name of cacheNames) {
                    await caches.delete(name);
                }
            }

            // Clear storage
            localStorage.clear();
            sessionStorage.clear();

            // Clear cookies
            document.cookie.split(";").forEach(c => {
                document.cookie = c.replace(/^ +/, "").replace(/=.*/, "=;expires=" + new Date().toUTCString() + ";path=/");
            });

            alert('‚úÖ FULL RESET COMPLETE!\n\nClick OK to reload the page.');
            
            // Update all displays
            await updateSWStatus();
            await updateCacheInfo();
            updateStorageInfo();
        }

        // Initialize
        updatePageInfo();
        updateSWStatus();
        updateCacheInfo();
        updateStorageInfo();

        // Auto-refresh status every 5 seconds
        setInterval(() => {
            updateSWStatus();
            updateCacheInfo();
            updateStorageInfo();
        }, 5000);
    </script>
</body>
</html>
